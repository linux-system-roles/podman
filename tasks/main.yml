# SPDX-License-Identifier: MIT
---
- name: Set platform/version specific variables
  include_tasks: set_vars.yml

- name: Ensure required packages are installed
  package:
    name: "{{ __podman_packages }}"
    state: present

- name: Get podman version
  command: podman --version
  changed_when: false
  register: __podman_version_output

- name: podman package version must be 4.2 or later
  fail:
    msg: >
      podman package version {{ __podman_version }} is too old -
      must be 4.2 or later
  when: __podman_version is version("4.2", "<")
  vars:
    __podman_version: "{{
      (__podman_version_output.stdout.split())[2] }}"

- name: Handle container.conf.d
  include_tasks: handle_container_conf_d.yml

- name: Handle registries.conf.d
  include_tasks: handle_registries_conf_d.yml

- name: Manage firewall for specified ports
  include_role:
    name: fedora.linux_system_roles.firewall
  vars:
    firewall: "{{ podman_firewall }}"
  when: podman_firewall | length > 0

- name: Manage selinux for specified ports
  include_role:
    name: fedora.linux_system_roles.selinux
  vars:
    selinux_ports: "{{ podman_selinux_ports }}"
  when: podman_selinux_ports | length > 0

- name: Handle Kubernetes specifications
  include_tasks: handle_kube_spec.yml
  loop: "{{ podman_kube_specs }}"
  loop_control:
    loop_var: __podman_kube_spec_item
